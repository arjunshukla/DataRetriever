<!DOCTYPE html>
<html lang='en'>

<head>
    <title>CME Data Tool</title>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js'></script>
    <script src='http://code.jquery.com/jquery.js'></script>
</head>

<body>

    <div class='container'>

        <h2>CME Data Collection Tool</h2>

        <p><strong>Step 1: </strong>Enter the video lecture URL</p>
        <p><strong>Step 2: </strong>Hit 'Enter' or click 'GO' to see the magic!</p>
        <p><strong>Step 3: </strong>You can click 'Download' button to export this data into a text file</p>
        <p><strong>Step 4: </strong>OR just copy/paste data from here to the Google doc</p>

        <div id='errorAlertBox' class='alert alert-danger alert-dismissable fade in'>
            <!-- <a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a> -->
            <p id='errorMessage'><strong>Danger!</strong> This alert box could indicate a dangerous or potentially negative action.</p>
        </div>


        <div class='form-group'>
            <label for='txtLectureName'>Lecture Link:</label>
            <input type='url' class='form-control' placeholder='https://members.drbeen.com/view/staphylococcal-gastroenteritis/SyexjFZB1m'
                id='txtLectureURL' required/>
        </div>

        <a type='button' class='btn btn-warning' onClick='fetchLectureData()'>GO</a>


    </div>

    <script>
        function fetchLectureData() {
            var lectureURL = document.getElementById('txtLectureURL');

            var settings = {
                "async": true,
                "crossDomain": true,
                "url": lectureURL,
                "method": "GET"
            }

            $.ajax(settings).done(function (response) {
                console.log(response);
            });


        }
    </script>

    <script>
        var CMETopicJSON = {};
        var arrQuestions = [];
        var arrOptions = [0, 'A', 'B', 'C', 'D', 'E', 'F'];
        var arrAnswers = [];
        var saveOperation = 'save';
        var readOperation = 'read';
        var questionsKey = 'questions';
        var CMEInfoKey = 'cme';


        initLoad();
        function initLoad() {
            $('#errorAlertBox').hide();
        }

        function validCMEInfo() {
            if (document.getElementById('txtLectureName').value && document.getElementById('txtTeacherName').value && document.getElementById('txtLectureDescription').value) {
                return true;
            }
            showAlertWithMessage('Please enter data in all fields');
            return false;
        }

        function validQuestion() {
            if (document.getElementById('txtQuestionText').value &&
                document.getElementById('txtAnswerChoice1').value &&
                document.getElementById('txtAnswerChoice2').value && validCorrectAnswer()) {
                return true;
            } else {
                showAlertWithMessage('Cannot create question! Valid question needs atleast 2 options and valid correct answer choice selection');
                arrAnswers = [];
                return false;
            }
        }

        function validCorrectAnswer() {
            $('#errorAlertBox').hide();
            getAnswerOptions();
            var selectedAnswer = document.getElementById('txtCorrectAnswerChoice').value;
            if (arrAnswers.some(item => item.choice === selectedAnswer)) {
                switch (selectedAnswer) {
                    case 'A':
                        if (!document.getElementById('txtAnswerChoice1').value) {
                            showAlertWithMessage('No answer in option A');
                            return false;
                        }
                        break;
                    case 'B':
                        if (!document.getElementById('txtAnswerChoice2').value) {
                            showAlertWithMessage('No answer in option B');
                            return false;
                        }
                        break;
                    case 'C':
                        if (!document.getElementById('txtAnswerChoice3').value) {
                            showAlertWithMessage('No answer in option C');
                            return false;
                        }
                        break;
                    case 'D':
                        if (!document.getElementById('txtAnswerChoice4').value) {
                            showAlertWithMessage('No answer in option D');
                            return false;
                        }
                        break;
                    case 'E':
                        if (!document.getElementById('txtAnswerChoice5').value) {
                            showAlertWithMessage('No answer in option E');
                            return false;
                        }
                        break;
                    case 'F':
                        if (!document.getElementById('txtAnswerChoice6').value) {
                            showAlertWithMessage('No answer in option F');
                            return false;
                        }
                        break;
                    default:
                        showAlertWithMessage('Please enter valid answer options');
                        return false;
                }
            } else {
                showAlertWithMessage('Invalid answer option sequence and correct answer selection.');
                return false;
            }
            return true;
        }

        function showAlertWithMessage(message) {
            document.getElementById('errorMessage').innerHTML = '<strong>Error!</strong> ' + message;
            $('#errorAlertBox').show();
        }

        function onNextBtnClick() {
            if (validCMEInfo()) {
                CMETopicJSON = {
                    'topic_uri': document.getElementById('txtLectureName').value,
                    'topic': document.getElementById('txtLectureName').value,
                    'provider': 'Drbeen Corp',
                    'coach': document.getElementById('txtTeacherName').value,
                    "credits": "1",
                    "contact-hours": "1",
                    'offer-date': getMonthString(),
                    'description': document.getElementById('txtLectureDescription').value,
                    'available': true
                }
                accessLocalStorage(saveOperation, CMEInfoKey, CMETopicJSON);
                document.getElementById('linkToQuestionsTab').click();
                $('#errorAlertBox').hide();
            }
        }

        function getMonthString() {
            var arrMonthString = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            var date = new Date();
            return (arrMonthString[date.getMonth()] + ' ' + date.getFullYear()).toString();
        }

        function getAnswerOptions() {
            for (var i = 1; i < 7; i++) {
                if (document.getElementById('txtAnswerChoice' + i).value) {
                    arrAnswers.push({
                        "choice": arrOptions[i],
                        "answer": getAnswerText(arrOptions[i])
                    });
                } else {
                    break;
                }
            }
            return arrAnswers;
        }

        function getAnswerText(option) {
            switch (option) {
                case 'A':
                    return document.getElementById('txtAnswerChoice1').value;
                    break;
                case 'B':
                    return document.getElementById('txtAnswerChoice2').value;
                    break;
                case 'C':
                    return document.getElementById('txtAnswerChoice3').value;
                    break;
                case 'D':
                    return document.getElementById('txtAnswerChoice4').value;
                    break;
                case 'E':
                    return document.getElementById('txtAnswerChoice5').value;
                    break;
                case 'F':
                    return document.getElementById('txtAnswerChoice6').value;
                    break;
                default:
                    return '';

            }
        }

        function getCorrectAnswerChoice() {

            // arrAnswers.forEach(function(element) {
            //     if (element.c .indexOf(document.getElementById('txtCorrectAnswerChoice').value) > 0) {
            //     return true;
            // }
            // return false;    
            // }, this);()


        }

        function addQuestion() {
            // getAnswerOptions();
            if (validQuestion()) {
                arrQuestions.push(
                    {
                        'module_id': document.getElementById('txtLectureName').value,
                        'text': document.getElementById('txtQuestionText').value,
                        'answers': arrAnswers,
                        'attribute': {
                            'answer_choice': document.getElementById('txtCorrectAnswerChoice').value,// this should be in answers array ,
                            'answer_text': getAnswerText(document.getElementById('txtCorrectAnswerChoice').value),
                            'isActive': 'true',
                            'type': 'MULTI',
                            'difficulty': 'MEDIUM',
                            'month': getMonthString()
                        }
                    });
                // Add questions array to local storage
                accessLocalStorage(saveOperation, questionsKey, arrQuestions);
                newQuestion();
            }
        }

        function accessLocalStorage(operation, key, value) {
            $('#errorAlertBox').hide();
            // Check browser support
            if (typeof (Storage) !== "undefined") {
                if (operation === 'save') {
                    localStorage.setItem(key, JSON.stringify(value));
                } else if (operation === 'read') {
                    return JSON.parse(localStorage.getItem(key));
                } else {
                    showAlertWithMessage('Please pass \'save\' to store; or \'read\' to access sotred object');
                }
            } else {
                showAlertWithMessage('Sorry, your browser does not support Web browser Local Storage...');
            }
        }

        function newQuestion() {
            document.getElementById('txtQuestionText').value = '';
            document.getElementById('txtAnswerChoice1').value = '';
            document.getElementById('txtAnswerChoice2').value = '';
            document.getElementById('txtAnswerChoice3').value = '';
            document.getElementById('txtAnswerChoice4').value = '';
            document.getElementById('txtAnswerChoice5').value = '';
            document.getElementById('txtAnswerChoice6').value = '';
            $("#txtCorrectAnswerChoice")[0].selectedIndex = 0;
            arrAnswers = [];
            // document.getElementById('txt').value = '';
        }

        function getQuestionsList() {
            var questionsString = '';

            arrQuestions.forEach(function (element) {
                if (questionsString === '') {
                    questionsString = JSON.stringify(element);
                } else {
                    questionsString = questionsString + ',' + JSON.stringify(element);
                }
            }, this);

            // var patt = /\\/

            var res = questionsString.replace(/\\\\/g, '');
            console.log(res);
            return res;
        }


        function newLecture() {

        }

        function downloadAndEnd() {

            /***** Steps to finish creating questions and download files:
                    1. Add entered question to list adding quest - done
                    2. Create JSON object for CME topic - done
                    3. Create JSON object for questions - done
                    4. Dowload both JSON files - done
                    5. Reload page to refresh memory and move to CME tab to enter next CME lecture details - pending
            */

            downloadCMEInfo(JSON.stringify(
                accessLocalStorage(readOperation, CMEInfoKey, null), null, 2));

            downlaodQuestions(JSON.stringify(
                accessLocalStorage(readOperation, questionsKey, null), null, 2));
        }

        function downloadCMEInfo(cmeJSON) {
            var blob = new Blob([cmeJSON], { type: 'application/json' });
            var url = URL.createObjectURL(blob);

            var a = document.createElement('a');
            a.download = document.getElementById('txtLectureName').value + '_topic.json';
            a.href = url;
            a.textContent = 'Download both JSONs';
            a.click();
            // document.getElementById('cme').appendChild(a);
        }

        function downlaodQuestions(jsonData) {
            jsonData = jsonData.substring(1, jsonData.length - 1);
            var blob = new Blob([jsonData], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.download = document.getElementById('txtLectureName').value + '_questions.json';
            a.href = url;
            a.textContent = 'Download backup.json';
            a.click();
        }


        function recoverData() {
            CMETopicJSON = accessLocalStorage(readOperation, CMEInfoKey, null);
            document.getElementById('txtLectureName').value = CMETopicJSON.topic;
            document.getElementById('txtTeacherName').value = CMETopicJSON.coach;
            document.getElementById('txtLectureDescription').value = CMETopicJSON.description;

            // setTimeout(function(){
            onNextBtnClick();
            arrQuestions = accessLocalStorage(readOperation, questionsKey, null);
            // }, 1000);
        }



        /*
        1. Add counter for no of questions added
        2. Add CME tab validation for Add Question button
        3. Refresh page on Download and End click to reset session
        4. Test for special characters in CME, Question and Answers JSON/Arrays
        5. Add auto-dismissing mesage toast for success events like question added, download completed, reset session, etc.
        6. Add local storage for savings questions incase Juveria looses power
        */
    </script>

</body>

</html>